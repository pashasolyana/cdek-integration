# Тестирование создания заказа CDEK

## Автоматический тест

Для быстрой проверки работы создания заказа используйте тестовый скрипт:

```bash
./test-order-creation.sh
```

Скрипт выполнит:
1. Проверку статуса CDEK API
2. Расчёт тарифа для маршрута Новосибирск → Москва
3. Создание тестового заказа с первым доступным тарифом

## Ручное тестирование через UI

### Шаг 1: Запуск сервисов

**Backend:**
```bash
cd cdek-api
yarn start:dev
# или
npm run start:dev
```

**Frontend:**
```bash
cd frontend
npm run dev
```

### Шаг 2: Открыть форму создания заказа

Откройте в браузере: `http://localhost:5173/create-order`

### Шаг 3: Заполнение формы

1. **Выберите торговую компанию** (любую из списка)
2. **Выберите способ доставки** (например, "От двери до двери")
3. **Заполните адрес отправления:**
   - Город: начните вводить "Новосибирск" и выберите из подсказок
   - Индекс: 630000
   - Адрес (опционально): ул. Ленина, д. 1

4. **Заполните адрес получения:**
   - Город: начните вводить "Москва" и выберите из подсказок
   - Индекс: 101000
   - Адрес (опционально): ул. Пушкина, д. 10

5. **Добавьте данные получателя:**
   - ФИО: Иванов Иван Иванович
   - Телефон: 79991234567

6. **Данные продавца (опционально):**
   - ФИО: ООО Компания
   - Телефон: 79991234568

7. **Добавьте посылку:**
   - Тип: Коробка
   - Вес: 1000 (грамм)
   - Длина: 30 (см)
   - Ширина: 20 (см)
   - Высота: 10 (см)

8. **Оценочная стоимость (опционально):** 5000

### Шаг 4: Расчёт стоимости

Нажмите кнопку **"Рассчитать стоимость"**

Вы увидите карточки с доступными тарифами. Каждая карточка содержит:
- Название тарифа
- Стоимость доставки
- Сроки доставки (в днях)
- Даты доставки (если доступны)

### Шаг 5: Выбор тарифа

Кликните на карточку тарифа или нажмите кнопку **"Выбрать"**

Карточка подсветится зелёным цветом, появится сообщение об успешном выборе.

### Шаг 6: Создание заказа

Нажмите кнопку **"Создать заказ"**

При успехе появится зелёное уведомление с UUID заказа и номером CDEK (если доступен).

## Тестирование через API (curl)

### 1. Проверка статуса
```bash
curl http://localhost:3000/cdek/status
```

### 2. Расчёт тарифа
```bash
curl -X POST http://localhost:3000/cdek/calculator/tarifflist \
  -H "Content-Type: application/json" \
  -d '{
    "date": "2025-10-22T12:00:00+07:00",
    "type": 1,
    "from_location": {
      "code": 270,
      "postal_code": "630000"
    },
    "to_location": {
      "code": 44,
      "postal_code": "101000"
    },
    "packages": [
      {
        "weight": 1000,
        "length": 30,
        "width": 20,
        "height": 10
      }
    ]
  }'
```

### 3. Создание заказа
```bash
curl -X POST http://localhost:3000/cdek/orders \
  -H "Content-Type: application/json" \
  -d '{
    "type": 1,
    "number": "TEST-ORDER-123",
    "tariff_code": 136,
    "comment": "Тестовый заказ",
    "recipient": {
      "name": "Иванов Иван Иванович",
      "phones": [{"number": "+79991234567"}]
    },
    "from_location": {
      "code": 270,
      "country_code": "RU",
      "city": "Новосибирск",
      "postal_code": "630000"
    },
    "to_location": {
      "code": 44,
      "country_code": "RU",
      "city": "Москва",
      "postal_code": "101000"
    },
    "packages": [
      {
        "number": "1",
        "weight": 1000,
        "length": 30,
        "width": 20,
        "height": 10,
        "comment": "-",
        "items": [
          {
            "name": "Тестовый товар",
            "ware_key": "TEST-001",
            "payment": {"value": 5000},
            "cost": 5000,
            "weight": 1000,
            "amount": 1
          }
        ]
      }
    ]
  }'
```

### 4. Получение информации о заказе
```bash
curl "http://localhost:3000/cdek/orders?cdek_number=1234567890"
```

## Проверка в базе данных

Подключитесь к PostgreSQL:
```bash
psql -U cdek_user -d cdek_db
```

Просмотр созданных заказов:
```sql
-- Список всех заказов
SELECT id, uuid, "cdekNumber", "tariffCode", "createdAt" 
FROM "CdekOrder" 
ORDER BY "createdAt" DESC 
LIMIT 10;

-- Детали заказа
SELECT * FROM "CdekOrder" WHERE id = 1;

-- Посылки заказа
SELECT * FROM "CdekOrderPackage" WHERE "orderId" = 1;

-- Товары в посылках
SELECT * FROM "CdekOrderItem" WHERE "packageId" = 1;

-- Журнал запросов
SELECT * FROM "CdekOrderRequest" WHERE "orderId" = 1;
```

## Ожидаемые результаты

### Успешное создание
✅ Статус код: 201  
✅ `success: true`  
✅ Возвращён `entity.uuid`  
✅ Заказ сохранён в БД  
✅ На фронтенде зелёное уведомление  

### Возможные ошибки

#### "comment cannot be empty"
Причина: в packages не указан comment или он пустой  
Решение: добавьте `"comment": "-"` в каждую посылку

#### "Invalid postal_code"
Причина: неверный формат индекса  
Решение: используйте 6 цифр (например, "630000")

#### "City code not found"
Причина: город не выбран из списка подсказок  
Решение: обязательно выбирайте город из автокомплита

#### "Tariff not available"
Причина: выбранный тариф недоступен для маршрута  
Решение: выполните расчёт заново и выберите другой тариф

## Логирование

### Backend
Логи сохраняются в консоль и таблицу `api_logs`:
```sql
SELECT * FROM api_logs ORDER BY created_at DESC LIMIT 20;
```

### Frontend
Откройте DevTools (F12) → Console для просмотра:
- Запросов к API
- Ответов от сервера
- Ошибок валидации
