# Компонент YMap - Карта пунктов выдачи CDEK

## Описание

Интерактивная карта на основе Яндекс.Карт для отображения пунктов выдачи CDEK с автоматической загрузкой точек для видимой области.

## Основные возможности

### 1. Динамическая загрузка точек
- Точки загружаются автоматически для текущей видимой области карты (bbox)
- При перемещении или зуме карты точки перезагружаются с задержкой 500мс (debounce)
- Ограничение: до 1000 точек на одну загрузку

### 2. Типы маркеров
- **Зелёные маркеры** - Пункты выдачи заказов (ПВЗ)
- **Оранжевые маркеры** - Постаматы

### 3. Кластеризация
- Автоматическое группирование близко расположенных точек
- При клике на кластер - приближение и раскрытие
- Адаптивный размер кластеров

### 4. Информационная панель
При клике на маркер отображается панель с информацией:
- Тип точки (ПВЗ/Постамат)
- Код пункта выдачи
- Полный адрес
- Город
- Телефоны с добавочными номерами
- Режим работы по дням недели
- Возможности (выдача, приём, оплата наличными/картой)
- Весовые ограничения

### 5. Панель управления
- **Счётчик точек** - показывает количество загруженных ПВЗ
- **Кнопка обновления** - ручная перезагрузка точек для текущей области

## Использование

```vue
<template>
  <YMap />
</template>

<script setup>
import YMap from '@/components/YMap.vue'
</script>
```

## Технические детали

### API эндпоинт
```
GET /cdek/delivery-points/db
```

Параметры:
- `lat_min`, `lat_max` - границы по широте
- `lon_min`, `lon_max` - границы по долготе
- `limit` - максимальное количество точек (по умолчанию 1000)
- `offset` - смещение для пагинации

### Структура данных точки

```typescript
interface DeliveryPoint {
  uuid: string
  code: string
  type: 'PVZ' | 'POSTAMAT' | 'UNKNOWN'
  city: string
  address: string
  addressFull: string
  latitude: number
  longitude: number
  weightMin: number | null
  weightMax: number | null
  phones: Array<{ number: string; addl: string | null }>
  workTimes: Array<{ day: number; time: string }>
  isHandout: boolean | null
  isReception: boolean | null
  haveCash: boolean | null
  haveCashless: boolean | null
}
```

## Производительность

### Оптимизации
1. **Debounce** - загрузка с задержкой 500мс после остановки движения карты
2. **Лимит точек** - максимум 1000 точек за запрос
3. **Bbox фильтрация** - загружаются только точки в видимой области
4. **Кластеризация** - снижение нагрузки при большом количестве маркеров

### Рекомендации
- Для оптимальной работы используйте PostgreSQL с PostGIS расширением
- При большом количестве точек (>5000) рекомендуется увеличить зум карты

## Настройка

### Изменение начальной позиции карты

```typescript
const mapCenter = ref<[number, number]>([30.315868, 59.939095]) // Санкт-Петербург
const mapZoom = ref(12)
```

### Изменение лимита загружаемых точек

```typescript
const response = await cdekService.getDeliveryPointsFromDb({
  lat_min: bounds.lat_min,
  lat_max: bounds.lat_max,
  lon_min: bounds.lon_min,
  lon_max: bounds.lon_max,
  limit: 500, // Изменить здесь
  offset: 0
})
```

### Изменение времени debounce

```typescript
loadTimeout = setTimeout(() => {
  loadDeliveryPointsForCurrentView()
}, 1000) // Изменить задержку (в миллисекундах)
```

## Стилизация

Все стили находятся в `<style scoped>` секции компонента и легко настраиваются:

- `.marker` - стили маркеров ПВЗ
- `.marker-postamat` - стили маркеров постаматов
- `.cluster` - стили кластеров
- `.info-panel` - информационная панель
- `.map-controls` - панель управления

## Возможные улучшения

1. Фильтры по типу ПВЗ/Постамат
2. Поиск по адресу/городу
3. Построение маршрута до выбранной точки
4. Сохранение выбранной точки в localStorage
5. Экспорт списка точек в CSV/Excel
6. Интеграция с геолокацией пользователя
